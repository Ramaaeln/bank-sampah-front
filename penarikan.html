<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Penarikan Saldo - Bank Sampah Digital</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body class="dashboard">
<header class="dashboard-header">
    <div class="container">
        <nav class="dashboard-nav">
            <div class="nav-brand">
                <span class="logo">‚ôªÔ∏è</span>
                <span class="brand-name">Bank Sampah Digital</span>
            </div>
            <ul class="dashboard-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="transaksi.html">Transaksi Baru</a></li>
                <li><a href="penarikan.html" class="active">Penarikan</a></li>
            </ul>
            <div class="nav-buttons">
                <button id="logoutBtn" class="btn btn-outline">Logout</button>
            </div>
        </nav>
    </div>
</header>

<main class="dashboard-content">
<div class="container">
    <div id="alert-container"></div>

    <div style="max-width:700px; margin:0 auto;">
        <div class="card" style="background:linear-gradient(135deg,#10b981,#059669); color:white; text-align:center;">
            <h3>üí∞ Saldo Tersedia</h3>
            <div id="saldoTersedia" style="font-size:3rem; font-weight:bold;">Rp 0</div>
        </div>

        <div class="card" style="margin-top:1rem;">
            <form id="penarikanForm">
                <div class="form-group">
                    <label for="jumlah">Jumlah Penarikan (Rp)</label>
                    <input type="number" id="jumlah" name="jumlah" min="10000" step="1000" required placeholder="Minimal Rp 10.000">
                </div>

                <div class="form-group">
                    <label for="metode">Metode Penarikan</label>
                    <select id="metode" name="metode" required>
                        <option value="">Pilih metode...</option>
                        <option value="Transfer Bank">üè¶ Transfer Bank</option>
                        <option value="E-Wallet">üì± E-Wallet</option>
                        <option value="Tunai">üíµ Tunai</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:1rem;">
                    <span id="btnText">‚úÖ Ajukan Penarikan</span>
                    <span id="btnLoader" style="display:none;">‚è≥ Memproses...</span>
                </button>
            </form>
        </div>
    </div>
</div>
</main>

<script>
    const token = localStorage.getItem('access_token');
    if(!token) window.location.href='login.html';
    
    const alertContainer = document.getElementById('alert-container');
    const saldoDiv = document.getElementById('saldoTersedia');
    const form = document.getElementById('penarikanForm');
    const btnText = document.getElementById('btnText');
    const btnLoader = document.getElementById('btnLoader');
    let currentSaldo = 0;
    
    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('access_token');
        window.location.href = 'login.html';
    });
    
    // Memuat saldo awal dari dashboard
    async function loadSaldo() {
        try {
            const res = await fetch('https://bank-sampah-rxmo.vercel.app/api/dashboard', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            if (data.success) {
                currentSaldo = data.user.saldo;
                saldoDiv.textContent = data.user.saldo_formatted;
            } else {
                window.location.href = 'login.html';
            }
        } catch (err) {
            showAlert('error', 'Gagal memuat saldo!');
        }
    }
    
    form.addEventListener('submit', async e => {
        e.preventDefault();
        const jumlah = parseInt(document.getElementById('jumlah').value);
        const metode = document.getElementById('metode').value;
    
        // Validasi saldo di sisi klien
        if (jumlah > currentSaldo) { 
            showAlert('error', 'Jumlah melebihi saldo yang tersedia'); 
            return; 
        }
    
        form.querySelector('button').disabled = true;
        btnText.style.display = 'none';
        btnLoader.style.display = 'inline';
    
        try {
            // Gunakan URL yang sesuai dengan route backend
            const res = await fetch('https://bank-sampah-rxmo.vercel.app/api/tarik', {
                method: 'POST',
                headers: { 
                    'Authorization': 'Bearer ' + token, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({ jumlah, metode })
            });
            
            const data = await res.json();
            
            if (data.success) {
                showAlert('success', data.message);
                // Update tampilan saldo tanpa refresh
                currentSaldo = data.data.saldo_baru;
                saldoDiv.textContent = data.data.saldo_baru_formatted;
                form.reset();
            } else {
                showAlert('error', data.message);
            }
        } catch (err) { 
            showAlert('error', 'Terjadi kesalahan koneksi!'); 
        } finally {
            form.querySelector('button').disabled = false;
            btnText.style.display = 'inline';
            btnLoader.style.display = 'none';
        }
    });
    
    function showAlert(type, msg) {
        const cls = type === 'success' ? 'alert-success' : 'alert-error';
        alertContainer.innerHTML = `<div class="alert ${cls}">${msg}</div>`;
        setTimeout(() => alertContainer.innerHTML = '', 5000);
    }
    
    window.addEventListener('DOMContentLoaded', loadSaldo);
    </script>
</body>
</html>
